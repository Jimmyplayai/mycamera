{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}GPUç›‘æ§å›¾è¡¨{% endblock %}

{% block extrahead %}
{{ block.super }}
<script src="{% static 'js/chart.min.js' %}"></script>
<style>
    .gpu-dashboard {
        padding: 20px;
        max-width: 1600px;
        margin: 0 auto;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .stat-card h3 {
        margin: 0 0 10px 0;
        font-size: 14px;
        color: #666;
        font-weight: normal;
    }

    .stat-card .value {
        font-size: 28px;
        font-weight: bold;
        color: #333;
    }

    .stat-card.warning .value {
        color: #ffa500;
    }

    .stat-card.critical .value {
        color: #ff4444;
    }

    .stat-card.success .value {
        color: #28a745;
    }

    .controls {
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
    }

    .controls label {
        font-weight: bold;
        margin-right: 5px;
    }

    .controls select, .controls button {
        padding: 8px 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }

    .controls button {
        background: #0066cc;
        color: white;
        border: none;
        cursor: pointer;
    }

    .controls button:hover {
        background: #0052a3;
    }

    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(700px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .chart-container {
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .chart-container h2 {
        margin: 0 0 15px 0;
        font-size: 18px;
        color: #333;
    }

    .chart-wrapper {
        position: relative;
        height: 300px;
    }

    .loading {
        text-align: center;
        padding: 50px;
        color: #666;
    }

    .error {
        background: #ffebee;
        border: 1px solid #ff4444;
        border-radius: 4px;
        padding: 15px;
        color: #c62828;
        margin-bottom: 20px;
    }

    .refresh-status {
        display: inline-block;
        margin-left: 10px;
        padding: 5px 10px;
        background: #e8f5e9;
        border-radius: 4px;
        font-size: 12px;
        color: #2e7d32;
    }
</style>
{% endblock %}

{% block content %}
<div class="gpu-dashboard">
    <h1 style="margin-bottom: 20px;">
        ğŸ“Š GPUç›‘æ§å›¾è¡¨
        <a href="{% url 'admin:cameras_gpumetrics_changelist' %}" style="float: right; font-size: 14px; text-decoration: none; background: #0066cc; color: white; padding: 8px 15px; border-radius: 4px;">è¿”å›åˆ—è¡¨</a>
    </h1>

    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
    <div class="stats-grid">
        <div class="stat-card">
            <h3>æ€»è®°å½•æ•°</h3>
            <div class="value">{{ stats.total_records|default:0 }}</div>
        </div>
        <div class="stat-card warning">
            <h3>è­¦å‘Šæ•°</h3>
            <div class="value">{{ stats.warning_count|default:0 }}</div>
        </div>
        <div class="stat-card critical">
            <h3>ä¸¥é‡å‘Šè­¦æ•°</h3>
            <div class="value">{{ stats.critical_count|default:0 }}</div>
        </div>
        <div class="stat-card success">
            <h3>å¹³å‡GPUåˆ©ç”¨ç‡</h3>
            <div class="value">{{ stats.avg_gpu_util|floatformat:1|default:"-" }}%</div>
        </div>
        <div class="stat-card">
            <h3>å³°å€¼GPUåˆ©ç”¨ç‡</h3>
            <div class="value">{{ stats.max_gpu_util|floatformat:1|default:"-" }}%</div>
        </div>
        <div class="stat-card">
            <h3>æœ€é«˜æ¸©åº¦</h3>
            <div class="value">{{ stats.max_temperature|floatformat:1|default:"-" }}Â°C</div>
        </div>
    </div>

    <!-- æ§åˆ¶é¢æ¿ -->
    <div class="controls">
        <div>
            <label for="timeRange">æ—¶é—´èŒƒå›´:</label>
            <select id="timeRange">
                <option value="1" selected>æœ€è¿‘1å°æ—¶</option>
                <option value="6">æœ€è¿‘6å°æ—¶</option>
                <option value="24">æœ€è¿‘24å°æ—¶</option>
                <option value="168">æœ€è¿‘7å¤©</option>
                <option value="720">æœ€è¿‘30å¤©</option>
            </select>
        </div>

        <div>
            <label for="taskTypeFilter">ä»»åŠ¡ç±»å‹:</label>
            <select id="taskTypeFilter">
                <option value="">å…¨éƒ¨</option>
                <option value="idle">ç©ºé—²</option>
                <option value="yolo">YOLOv8æ£€æµ‹</option>
                <option value="blip2">BLIP2æè¿°ç”Ÿæˆ</option>
                <option value="other">å…¶ä»–</option>
            </select>
        </div>

        <button onclick="refreshData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>

        <div>
            <label>
                <input type="checkbox" id="autoRefresh" checked>
                è‡ªåŠ¨åˆ·æ–° (10ç§’)
            </label>
            <span class="refresh-status" id="refreshStatus">å·²å¯ç”¨</span>
        </div>
    </div>

    <!-- é”™è¯¯æç¤º -->
    <div id="errorMessage" class="error" style="display: none;"></div>

    <!-- å›¾è¡¨åŒºåŸŸ -->
    <div class="charts-grid">
        <div class="chart-container">
            <h2>ğŸ“ˆ GPUåˆ©ç”¨ç‡è¶‹åŠ¿</h2>
            <div class="chart-wrapper">
                <canvas id="gpuUtilChart"></canvas>
            </div>
        </div>

        <div class="chart-container">
            <h2>ğŸ’¾ æ˜¾å­˜ä½¿ç”¨æƒ…å†µ</h2>
            <div class="chart-wrapper">
                <canvas id="memoryChart"></canvas>
            </div>
        </div>

        <div class="chart-container">
            <h2>ğŸŒ¡ï¸ GPUæ¸©åº¦ç›‘æ§</h2>
            <div class="chart-wrapper">
                <canvas id="temperatureChart"></canvas>
            </div>
        </div>

        <div class="chart-container">
            <h2>ğŸ“Š ä»»åŠ¡ç±»å‹åˆ†å¸ƒ</h2>
            <div class="chart-wrapper">
                <canvas id="taskTypeChart"></canvas>
            </div>
        </div>
    </div>

    <div id="loadingMessage" class="loading">æ­£åœ¨åŠ è½½æ•°æ®...</div>
</div>

<script>
    // Chart.js å›¾è¡¨å®ä¾‹
    let gpuUtilChart, memoryChart, temperatureChart, taskTypeChart;
    let autoRefreshInterval = null;

    // API URL
    const apiUrl = '{% url "gpu_metrics_api" %}';

    // åˆå§‹åŒ–å›¾è¡¨
    function initCharts() {
        // GPUåˆ©ç”¨ç‡å›¾è¡¨
        const gpuCtx = document.getElementById('gpuUtilChart').getContext('2d');
        gpuUtilChart = new Chart(gpuCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'GPUåˆ©ç”¨ç‡ (%)',
                    data: [],
                    borderColor: '#0066cc',
                    backgroundColor: 'rgba(0, 102, 204, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    },
                    x: {
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true
                    }
                }
            }
        });

        // æ˜¾å­˜ä½¿ç”¨å›¾è¡¨
        const memCtx = document.getElementById('memoryChart').getContext('2d');
        memoryChart = new Chart(memCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'æ˜¾å­˜ä½¿ç”¨ç‡ (%)',
                    data: [],
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    },
                    x: {
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true
                    }
                }
            }
        });

        // æ¸©åº¦å›¾è¡¨
        const tempCtx = document.getElementById('temperatureChart').getContext('2d');
        temperatureChart = new Chart(tempCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'GPUæ¸©åº¦ (Â°C)',
                    data: [],
                    borderColor: '#ff6384',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + 'Â°C';
                            }
                        }
                    },
                    x: {
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true
                    }
                }
            }
        });

        // ä»»åŠ¡ç±»å‹å›¾è¡¨
        const taskCtx = document.getElementById('taskTypeChart').getContext('2d');
        taskTypeChart = new Chart(taskCtx, {
            type: 'doughnut',
            data: {
                labels: [],
                datasets: [{
                    data: [],
                    backgroundColor: [
                        '#0066cc',
                        '#28a745',
                        '#ffa500',
                        '#ff4444',
                        '#9c27b0'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right'
                    }
                }
            }
        });
    }

    // åŠ è½½æ•°æ®
    async function refreshData() {
        const hours = document.getElementById('timeRange').value;
        const taskType = document.getElementById('taskTypeFilter').value;

        let url = `${apiUrl}?hours=${hours}`;
        if (taskType) {
            url += `&task_type=${taskType}`;
        }

        try {
            document.getElementById('loadingMessage').style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';

            const response = await fetch(url);
            const result = await response.json();

            if (!result.success) {
                throw new Error(result.error || 'åŠ è½½æ•°æ®å¤±è´¥');
            }

            const data = result.data;

            // æ›´æ–°GPUåˆ©ç”¨ç‡å›¾è¡¨
            gpuUtilChart.data.labels = data.timestamps;
            gpuUtilChart.data.datasets[0].data = data.gpu_utilization;
            gpuUtilChart.update();

            // æ›´æ–°æ˜¾å­˜å›¾è¡¨
            memoryChart.data.labels = data.timestamps;
            memoryChart.data.datasets[0].data = data.memory_percent;
            memoryChart.update();

            // æ›´æ–°æ¸©åº¦å›¾è¡¨
            temperatureChart.data.labels = data.timestamps;
            temperatureChart.data.datasets[0].data = data.temperature;
            temperatureChart.update();

            // æ›´æ–°ä»»åŠ¡ç±»å‹å›¾è¡¨
            if (result.task_stats && result.task_stats.length > 0) {
                taskTypeChart.data.labels = result.task_stats.map(s => s.task_type_display);
                taskTypeChart.data.datasets[0].data = result.task_stats.map(s => s.count);
                taskTypeChart.update();
            }

            document.getElementById('loadingMessage').style.display = 'none';

        } catch (error) {
            console.error('Error loading data:', error);
            document.getElementById('errorMessage').textContent = 'åŠ è½½æ•°æ®å¤±è´¥: ' + error.message;
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('loadingMessage').style.display = 'none';
        }
    }

    // è‡ªåŠ¨åˆ·æ–°æ§åˆ¶
    function toggleAutoRefresh() {
        const checkbox = document.getElementById('autoRefresh');
        const status = document.getElementById('refreshStatus');

        if (checkbox.checked) {
            // å¯åŠ¨è‡ªåŠ¨åˆ·æ–°ï¼ˆ10ç§’ï¼‰
            autoRefreshInterval = setInterval(refreshData, 10000);
            status.textContent = 'å·²å¯ç”¨';
            status.style.background = '#e8f5e9';
            status.style.color = '#2e7d32';
        } else {
            // åœæ­¢è‡ªåŠ¨åˆ·æ–°
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
            status.textContent = 'å·²ç¦ç”¨';
            status.style.background = '#ffebee';
            status.style.color = '#c62828';
        }
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        initCharts();
        refreshData();

        // ç›‘å¬æ—¶é—´èŒƒå›´å’Œä»»åŠ¡ç±»å‹å˜åŒ–
        document.getElementById('timeRange').addEventListener('change', refreshData);
        document.getElementById('taskTypeFilter').addEventListener('change', refreshData);
        document.getElementById('autoRefresh').addEventListener('change', toggleAutoRefresh);

        // å¯åŠ¨è‡ªåŠ¨åˆ·æ–°
        toggleAutoRefresh();
    });

    // é¡µé¢å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨
    window.addEventListener('beforeunload', function() {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
        }
    });
</script>
{% endblock %}
